<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>–£—á—ë—Ç –∞—Ä–µ–Ω–¥—ã –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .payment-card { border-left: 4px solid #28a745; }
    .debt-card { border-left: 4px solid #dc3545; }
    .table th { background-color: #f8f9fa; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h1 class="mb-4">üìä –£—á—ë—Ç –∞—Ä–µ–Ω–¥—ã –≤–µ–ª–æ—Å–∏–ø–µ–¥–æ–≤</h1>
    
    <!-- –§–∏–ª—å—Ç—Ä –ø–æ –∫–ª–∏–µ–Ω—Ç—É -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <label for="clientFilter" class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –∫–ª–∏–µ–Ω—Ç—É:</label>
            <input type="text" id="clientFilter" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞...">
          </div>
          <div class="col-md-3">
            <label for="dateFrom" class="form-label">–° –¥–∞—Ç—ã:</label>
            <input type="date" id="dateFrom" class="form-control">
          </div>
          <div class="col-md-3">
            <label for="dateTo" class="form-label">–ü–æ –¥–∞—Ç—É:</label>
            <input type="date" id="dateTo" class="form-control">
          </div>
        </div>
        <button onclick="loadData()" class="btn btn-primary mt-3">–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
      </div>
    </div>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div id="summary" class="row mb-4"></div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ –¥–∞–Ω–Ω—ã—Ö -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</h5>
        <button class="btn btn-success btn-sm" onclick="showAddForm()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>–ö–ª–∏–µ–Ω—Ç</th>
                <th>–í–µ–ª–æ—Å–∏–ø–µ–¥</th>
                <th>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</th>
                <th>–î–æ–ª–∂–µ–Ω</th>
                <th>–ó–∞–ø–ª–∞—Ç–∏–ª</th>
                <th>–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</th>
                <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
              </tr>
            </thead>
            <tbody id="dataTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
  <div class="modal fade" id="addModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="paymentForm">
            <div class="mb-3">
              <label class="form-label">–ö–ª–∏–µ–Ω—Ç *</label>
              <input type="text" name="–ö–ª–∏–µ–Ω—Ç" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label">–í–µ–ª–æ—Å–∏–ø–µ–¥</label>
              <input type="text" name="–í–µ–ª–æ—Å–∏–ø–µ–¥" class="form-control">
            </div>
            <div class="mb-3">
              <label class="form-label">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã *</label>
              <input type="date" name="–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã" class="form-control" required>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">–î–æ–ª–∂–µ–Ω –∑–∞–ø–ª–∞—Ç–∏—Ç—å</label>
                <input type="number" name="–î–æ–ª–∂–µ–Ω –∑–∞–ø–ª–∞—Ç–∏—Ç—å" class="form-control" value="180">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">–ó–∞–ø–ª–∞—Ç–∏–ª</label>
                <input type="number" name="–ó–∞–ø–ª–∞—Ç–∏–ª" class="form-control" value="180">
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞</label>
              <textarea name="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-3">
              <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —Å–µ–±—è</label>
              <textarea name="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —Å–µ–±—è" class="form-control" rows="2"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
          <button type="button" class="btn btn-primary" onclick="addPayment()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    function loadData() {
      const client = document.getElementById('clientFilter').value;
      const url = client ? `?method=getClient&client=${encodeURIComponent(client)}` : '?method=getAll';
      
      google.script.run
        .withSuccessHandler(displayData)
        .withFailureHandler(showError)
        .doGet({ method: client ? 'getClient' : 'getAll', client: client || null });
    }
    
    // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    function displayData(response) {
      const data = response.success ? response.data : [];
      const tbody = document.getElementById('dataTable');
      const summaryDiv = document.getElementById('summary');
      
      // –û—á–∏—â–∞–µ–º —Ç–∞–±–ª–∏—Ü—É
      tbody.innerHTML = '';
      
      if (!Array.isArray(data) || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
        summaryDiv.innerHTML = '';
        return;
      }
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ç–∞–±–ª–∏—Ü—É
      data.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${item['–ö–ª–∏–µ–Ω—Ç'] || ''}</td>
          <td>${item['–í–µ–ª–æ—Å–∏–ø–µ–¥'] || ''}</td>
          <td>${item['–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã'] || ''}</td>
          <td>${item['–î–æ–ª–∂–µ–Ω –∑–∞–ø–ª–∞—Ç–∏—Ç—å'] || 0} ‚Ç¥</td>
          <td>${item['–ó–∞–ø–ª–∞—Ç–∏–ª'] || 0} ‚Ç¥</td>
          <td><span class="badge ${item['–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å'] === '0 -' ? 'bg-success' : 'bg-danger'}">
            ${item['–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å'] || '0 -'}
          </span></td>
          <td>${item['–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞'] || ''}</td>
        `;
        tbody.appendChild(row);
      });
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
      updateSummary(data);
    }
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    function updateSummary(data) {
      const totalPayments = data.length;
      const clients = [...new Set(data.map(item => item['–ö–ª–∏–µ–Ω—Ç']))];
      const totalDebt = data.reduce((sum, item) => {
        const debt = item['–ó–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å'];
        if (debt && debt !== '0 -') {
          const match = debt.match(/(\d+)/);
          return sum + (match ? parseInt(match[1]) : 0);
        }
        return sum;
      }, 0);
      
      document.getElementById('summary').innerHTML = `
        <div class="col-md-4">
          <div class="card payment-card">
            <div class="card-body">
              <h5 class="card-title">–í—Å–µ–≥–æ –ø–ª–∞—Ç–µ–∂–µ–π</h5>
              <p class="card-text display-6">${totalPayments}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–ª–∏–µ–Ω—Ç–æ–≤</h5>
              <p class="card-text display-6">${clients.length}</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card ${totalDebt > 0 ? 'debt-card' : ''}">
            <div class="card-body">
              <h5 class="card-title">–û–±—â–∞—è –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç—å</h5>
              <p class="card-text display-6">${totalDebt} ‚Ç¥</p>
            </div>
          </div>
        </div>
      `;
    }
    
    // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
    function showAddForm() {
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ–≥–æ–¥–Ω—è—à–Ω—é—é –¥–∞—Ç—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const today = new Date().toISOString().split('T')[0];
      document.querySelector('[name="–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã"]').value = today;
      
      const modal = new bootstrap.Modal(document.getElementById('addModal'));
      modal.show();
    }
    
    // –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂
    function addPayment() {
      const form = document.getElementById('paymentForm');
      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }
      
      const formData = new FormData(form);
      const record = {};
      formData.forEach((value, key) => {
        record[key] = value;
      });
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç dd.mm.yyyy
      if (record['–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã']) {
        const date = new Date(record['–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã']);
        record['–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã'] = date.toLocaleDateString('ru-RU');
      }
      
      google.script.run
        .withSuccessHandler(response => {
          if (response.success) {
            alert('–ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
            bootstrap.Modal.getInstance(document.getElementById('addModal')).hide();
            form.reset();
            loadData();
          } else {
            alert('–û—à–∏–±–∫–∞: ' + response.error);
          }
        })
        .withFailureHandler(showError)
        .doPost({ method: 'addPayment', ...record });
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
    function showError(error) {
      console.error(error);
      alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: ' + error.message);
    }
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    document.addEventListener('DOMContentLoaded', loadData);
  </script>
</body>
</html>